<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoldenMM - Fixed Version</title>
    <link rel="stylesheet" href="TemplateData/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Additional error handling styles */
        .connection-error {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .error-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            max-width: 400px;
            border: 2px solid #f87171;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }
        
        .error-content h3 {
            color: #f87171;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }
        
        .error-content p {
            color: #e0e0e0;
            margin-bottom: 1.5rem;
        }
        
        .error-content button {
            background: linear-gradient(135deg, #f87171, #ef4444);
            color: #ffffff;
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .error-content button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(248, 113, 113, 0.4);
        }
        
        /* Unity container fixes */
        #unity-container {
            position: relative;
            z-index: 1;
        }
        
        /* Loading improvements */
        .loading-screen {
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .loading-content {
            text-align: center;
            color: #ffffff;
            max-width: 500px;
            padding: 2rem;
        }

        .game-logo {
            text-align: center;
            margin-bottom: 2rem;
        }

        .game-logo .main-logo {
            width: 80px !important;
            height: 80px !important;
            border-radius: 16px !important;
            border: 3px solid #ffd700 !important;
            object-fit: cover !important;
            margin-bottom: 1rem !important;
            animation: pulse 2s infinite !important;
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.4) !important;
            display: block !important;
            max-width: 100% !important;
            height: auto !important;
            background: #2a2a4e !important;
            position: relative !important;
            z-index: 10 !important;
        }

        /* Fallback icon if image fails to load */
        .game-logo .main-logo:not([src]), 
        .game-logo .main-logo[src=""],
        .game-logo .main-logo[src*="error"] {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            display: flex !important;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: #1a1a2e;
        }

        .game-logo .main-logo:not([src])::after, 
        .game-logo .main-logo[src=""]::after,
        .game-logo .main-logo[src*="error"]::after {
            content: "ðŸŽ®";
            font-size: 2.5rem;
        }

        .game-logo h1 {
            color: #ffd700;
            font-size: 2.5rem;
            margin: 0;
            font-weight: 600;
            text-shadow: 0 2px 10px rgba(255, 215, 0, 0.5);
        }

        .loading-animation {
            margin: 2rem 0;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 215, 0, 0.3);
            border-top: 4px solid #ffd700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        .loading-text {
            margin: 2rem 0;
        }

        .loading-text p {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            color: #e0e0e0;
        }

        .progress-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            justify-content: center;
            margin: 1rem 0;
        }

        .progress-bar {
            width: 200px;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffd700, #ffed4e);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .progress-text {
            color: #ffd700;
            font-weight: 600;
            min-width: 50px;
        }
        
        .loading-tips {
            background: rgba(255, 255, 255, 0.05);
            border-left: 4px solid #ffd700;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 2rem;
        }

        .loading-tips p {
            margin: 0;
            color: #e0e0e0;
            font-size: 0.9rem;
        }

        .loading-tips i {
            color: #ffd700;
            margin-right: 0.5rem;
        }

        /* Animations */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .fade-out {
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        
        /* Performance optimizations */
        .performance-warning {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(168, 85, 247, 0.9);
            color: #ffffff;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            z-index: 1000;
            display: none;
        }

        /* Game Room Loading Styles */
        .game-room-loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 15000;
            justify-content: center;
            align-items: center;
        }

        .game-room-loading .loading-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 3rem;
            text-align: center;
            max-width: 500px;
            border: 2px solid #ffd700;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.7);
            animation: slideIn 0.5s ease;
        }

        .game-room-loading .loading-header {
            margin-bottom: 2rem;
        }

        .game-room-loading .loading-header i {
            font-size: 3rem;
            color: #ffd700;
            margin-bottom: 1rem;
            animation: pulse 2s infinite;
        }

        .game-room-loading .loading-header h3 {
            color: #ffffff;
            font-size: 1.8rem;
            margin: 0;
            font-weight: 600;
        }

        .game-room-loading .loading-message {
            margin-bottom: 2rem;
            color: #e0e0e0;
        }

        .game-room-loading .bet-info {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid #ffd700;
            border-radius: 10px;
            padding: 0.75rem;
            margin-top: 1rem;
        }

        .game-room-loading .bet-amount {
            color: #ffd700;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .room-progress-container {
            margin: 2rem 0;
        }

        .room-progress-bar {
            width: 100%;
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .room-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffd700, #ffed4e);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .room-progress-text {
            color: #ffd700;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .loading-steps {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 2rem;
        }

        .loading-steps .step {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #888;
            font-size: 0.9rem;
            transition: color 0.3s ease;
        }

        .loading-steps .step.active {
            color: #ffd700;
        }

        .loading-steps .step.completed {
            color: #00ff88;
        }

        .loading-steps .step i {
            width: 20px;
            text-align: center;
        }

        /* Betting Interface Styles */
        .betting-interface {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 15px;
            padding: 1.5rem;
            border: 2px solid #ffd700;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 5000;
            min-width: 400px;
            animation: slideUp 0.5s ease;
        }

        .betting-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            color: #ffd700;
            justify-content: center;
        }

        .betting-header .logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 2px solid #ffd700;
            object-fit: cover;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
        }

        .betting-header i {
            font-size: 1.5rem;
        }

        .betting-header h3 {
            margin: 0;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .betting-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .bet-btn {
            background: linear-gradient(135deg, #2a2a4e 0%, #1e1e3e 100%);
            border: 2px solid #ffd700;
            border-radius: 12px;
            padding: 1rem;
            color: #ffffff;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
        }

        .bet-btn:hover {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #1a1a2e;
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(255, 215, 0, 0.4);
        }

        .bet-btn:active {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.6);
        }

        .bet-btn .bet-value {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .bet-btn .bet-currency {
            font-size: 1.5rem;
        }

        .balance-info {
            text-align: center;
            color: #e0e0e0;
            font-size: 1.1rem;
            padding: 0.75rem;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .balance-info span {
            font-weight: 600;
        }

        #playerBalance {
            color: #ffd700;
            font-weight: bold;
        }

        /* Animations */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(100%);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .betting-interface {
                min-width: 90%;
                left: 5%;
                transform: none;
            }
            
            .betting-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .game-room-loading .loading-content {
                margin: 1rem;
                padding: 2rem;
            }
            
            .loading-steps {
                grid-template-columns: 1fr;
            }

            /* Mobile fullscreen improvements */
            .loading-screen {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                z-index: 99999 !important;
            }

            .game-logo .main-logo {
                width: 100px !important;
                height: 100px !important;
            }

            .game-logo h1 {
                font-size: 2rem !important;
            }

            .loading-tips {
                font-size: 0.8rem;
                padding: 0.75rem;
            }

            .loading-tips p {
                margin: 0.5rem 0;
            }

            /* Hide address bar on mobile */
            body {
                height: 100vh;
                height: -webkit-fill-available;
                overflow: hidden;
            }

            html {
                height: -webkit-fill-available;
            }
        }

        /* Mobile landscape specific */
        @media (max-width: 768px) and (orientation: landscape) {
            .loading-content {
                max-width: 90%;
                padding: 1.5rem;
            }

            .game-logo {
                margin-bottom: 1rem;
            }

            .game-logo .main-logo {
                width: 60px !important;
                height: 60px !important;
            }

            .game-logo h1 {
                font-size: 1.5rem !important;
            }

            .loading-tips {
                margin-top: 1rem;
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-content">
            <div class="game-logo">
                <img src="TemplateData/shan.jpg" alt="Shan Logo" class="main-logo" 
                     onload="console.log('âœ… Logo loaded successfully'); this.style.border='3px solid #00ff00';" 
                     onerror="console.error('âŒ Logo failed to load:', this.src); this.style.display='none';">
                <h1>DelightMyanmar</h1>
            </div>
            
            <div class="loading-animation">
                <div class="spinner"></div>
            </div>
            
            <div class="loading-text">
                <p>Loading your adventure...</p>
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <span class="progress-text" id="progressText">0%</span>
                </div>
            </div>
            
            <div class="loading-tips">
                <p><i class="fas fa-lightbulb"></i> Tip: Use WASD or arrow keys to move</p>
                <p><i class="fas fa-music"></i> Touch anywhere to start background music</p>
            </div>
        </div>
    </div>

    <!-- Rotate Message -->
    <div class="rotate-message" id="rotateMessage">
        <div class="rotate-content">
            <i class="fas fa-mobile-alt"></i>
            <h3>Please Rotate Your Device</h3>
            <p>For the best gaming experience, please rotate to landscape mode</p>
        </div>
    </div>

    <!-- Performance Warning -->
    <div class="performance-warning" id="performanceWarning">
        <i class="fas fa-exclamation-triangle"></i>
        Performance optimizations applied for better gameplay
    </div>

    <!-- Unity Container -->
    <div id="unity-container" class="unity-container">
        <canvas id="unity-canvas"></canvas>
    </div>

    <!-- Game Controls -->
    <div class="game-controls">
        <button class="control-btn" id="settingsBtn" title="Settings">
            <i class="fas fa-cog"></i>
        </button>
        <button class="control-btn" id="helpBtn" title="Help">
            <i class="fas fa-question"></i>
        </button>
        <button class="control-btn" id="fullscreenBtn" title="Fullscreen">
            <i class="fas fa-expand"></i>
        </button>
    </div>

    <!-- Game Title Bar -->
    <div class="game-title-bar">
        <div class="game-info">
            <div class="game-title">DelightMyanmar v1.0.3</div>
            <div class="game-version">Fixed Version</div>
        </div>
        <div class="game-status">
            <div class="status-indicator" id="statusIndicator">
                <i class="fas fa-circle"></i>
                <span>Ready</span>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-cog"></i> Game Settings</h3>
                <button class="close-btn" id="closeSettings">&times;</button>
            </div>
            <div class="modal-body">
                <div class="setting-group">
                    <label>Graphics Quality</label>
                    <select id="graphicsQuality">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label>Sound Volume</label>
                    <input type="range" id="soundVolume" min="0" max="100" value="80">
                    <span class="volume-value" id="soundVolumeValue">80%</span>
                </div>
                <div class="setting-group">
                    <label>Music Volume</label>
                    <input type="range" id="musicVolume" min="0" max="100" value="60">
                    <span class="volume-value" id="musicVolumeValue">60%</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div class="modal" id="helpModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-question"></i> Help & Controls</h3>
                <button class="close-btn" id="closeHelp">&times;</button>
            </div>
            <div class="modal-body">
                <div class="control-section">
                    <h4>Keyboard Controls</h4>
                    <div class="control-grid">
                        <div class="control-item">
                            <span class="key">WASD</span>
                            <span class="action">Move</span>
                        </div>
                        <div class="control-item">
                            <span class="key">Space</span>
                            <span class="action">Jump</span>
                        </div>
                        <div class="control-item">
                            <span class="key">E</span>
                            <span class="action">Interact</span>
                        </div>
                        <div class="control-item">
                            <span class="key">ESC</span>
                            <span class="action">Pause</span>
                        </div>
                    </div>
                </div>
                <div class="control-section">
                    <h4>Mouse Controls</h4>
                    <div class="control-grid">
                        <div class="control-item">
                            <span class="key">Left Click</span>
                            <span class="action">Select</span>
                        </div>
                        <div class="control-item">
                            <span class="key">Right Click</span>
                            <span class="action">Context Menu</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Room Loading Progress -->
    <div class="game-room-loading" id="gameRoomLoading">
        <div class="loading-content">
            <div class="loading-header">
                <i class="fas fa-dice"></i>
                <h3>Joining Game Room</h3>
            </div>
            <div class="loading-message">
                <p>Preparing your game session...</p>
                <div class="bet-info">
                    Bet Amount: <span class="bet-amount" id="selectedBetAmount">0</span>
                </div>
            </div>
            <div class="room-progress-container">
                <div class="room-progress-bar">
                    <div class="room-progress-fill" id="roomProgressFill"></div>
                </div>
                <div class="room-progress-text" id="roomProgressText">Initializing...</div>
            </div>
            <div class="loading-steps">
                <div class="step" id="step1">
                    <i class="fas fa-server"></i>
                    <span>Connecting to server</span>
                </div>
                <div class="step" id="step2">
                    <i class="fas fa-users"></i>
                    <span>Finding available room</span>
                </div>
                <div class="step" id="step3">
                    <i class="fas fa-gamepad"></i>
                    <span>Loading game assets</span>
                </div>
                <div class="step" id="step4">
                    <i class="fas fa-check"></i>
                    <span>Ready to play</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Betting Interface -->
    <div class="betting-interface" id="bettingInterface">
        <div class="betting-header">
            <img src="TemplateData/shan.jpg" alt="Shan Logo" class="logo">
            <i class="fas fa-coins"></i>
            <h3>Place Your Bet</h3>
        </div>
        <div class="betting-buttons">
            <button class="bet-btn" data-amount="100">
                <span class="bet-value">100</span>
                <span class="bet-currency">ðŸ’°</span>
            </button>
            <button class="bet-btn" data-amount="300">
                <span class="bet-value">300</span>
                <span class="bet-currency">ðŸ’°</span>
            </button>
            <button class="bet-btn" data-amount="500">
                <span class="bet-value">500</span>
                <span class="bet-currency">ðŸ’°</span>
            </button>
            <button class="bet-btn" data-amount="800">
                <span class="bet-value">800</span>
                <span class="bet-currency">ðŸ’°</span>
            </button>
        </div>
        <div class="balance-info">
            <span>Balance: <span id="playerBalance">10,000</span> ðŸ’°</span>
        </div>
    </div>

    <!-- Sound Effects -->
    <audio id="betSound" preload="auto">
        <source src="sounds/trap-beat-266443.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <!-- Background Music -->
    <audio id="backgroundMusic" preload="auto" loop>
        <source src="sounds/trap-beat-266443.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <!-- Notification Container -->
    <div class="notification-container" id="notificationContainer"></div>

    <!-- Unity WebGL Fixes Script -->
    <script src="unity-webgl-fixes.js"></script>
    
    <!-- Unity WebGL Loader Script -->
    <script src="Build/SKMWebDelight.loader.js"></script>

    <!-- Main Game Script -->
    <script>
        // Game initialization with error handling
        class GoldenMMGame {
            constructor() {
                this.isInitialized = false;
                this.unityInstance = null;
                this.gameManager = null;
                this.setupEventListeners();
                this.initializeGame();
            }

            setupEventListeners() {
                // Settings button
                document.getElementById('settingsBtn').addEventListener('click', () => {
                    this.showModal('settingsModal');
                });

                // Help button
                document.getElementById('helpBtn').addEventListener('click', () => {
                    this.showModal('helpModal');
                });

                // Fullscreen button
                document.getElementById('fullscreenBtn').addEventListener('click', () => {
                    this.toggleFullscreen();
                });

                // Betting buttons
                document.querySelectorAll('.bet-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const amount = parseInt(e.currentTarget.dataset.amount);
                        this.placeBet(amount);
                    });
                });

                // Close buttons
                document.getElementById('closeSettings').addEventListener('click', () => {
                    this.hideModal('settingsModal');
                });

                document.getElementById('closeHelp').addEventListener('click', () => {
                    this.hideModal('helpModal');
                });

                // Volume controls
                document.getElementById('soundVolume').addEventListener('input', (e) => {
                    document.getElementById('soundVolumeValue').textContent = e.target.value + '%';
                });

                document.getElementById('musicVolume').addEventListener('input', (e) => {
                    document.getElementById('musicVolumeValue').textContent = e.target.value + '%';
                });

                // Modal backdrop clicks
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            this.hideModal(modal.id);
                        }
                    });
                });

                // Device orientation
                window.addEventListener('orientationchange', () => {
                    this.handleOrientationChange();
                });

                // Unity ready event
                window.addEventListener('unity-ready', () => {
                    this.onUnityReady();
                });

                // Game manager events
                window.addEventListener('gameManagerEvent', (e) => {
                    this.handleGameManagerEvent(e.detail);
                });
            }

            initializeGame() {
                console.log('ðŸŽ® Initializing GoldenMM Game...');
                
                // Setup global Unity error handling first
                this.setupGlobalUnityErrorHandling();
                
                // Setup audio system
                this.setupAudioSystem();
                
                // Check device orientation
                this.handleOrientationChange();
                
                // Initialize Unity WebGL
                this.initializeUnity();
                
                // Setup performance monitoring
                this.setupPerformanceMonitoring();
            }

            initializeUnity() {
                try {
                    // Check if Unity loader is available
                    if (typeof createUnityInstance === 'undefined') {
                        console.error('âŒ Unity loader not loaded. Please check if Build/SKMWebDelight.loader.js is accessible.');
                        this.showError('Unity loader not found. Please refresh the page.');
                        return;
                    }
                    
                    // Load Unity WebGL build
                    const canvas = document.getElementById('unity-canvas');
                    const loadingBar = document.getElementById('unity-loading-bar');
                    
                    // Unity configuration
                    const unityConfig = {
                        dataUrl: 'Build/SKMWebDelight.data',
                        frameworkUrl: 'Build/SKMWebDelight.framework.js',
                        codeUrl: 'Build/SKMWebDelight.wasm',
                        companyName: 'GoldenMM',
                        productName: 'GoldenMM Game',
                        productVersion: '1.0.3',
                        devicePixelRatio: 1,
                        webglContextAttributes: {
                            preserveDrawingBuffer: false,
                            antialias: false,
                            alpha: false,
                            depth: true,
                            stencil: false,
                            powerPreference: "high-performance"
                        }
                    };

                    // Create Unity instance with enhanced error handling
                    createUnityInstance(canvas, unityConfig, (progress) => {
                        // Update loading progress
                        const progressFill = document.getElementById('progressFill');
                        const progressText = document.getElementById('progressText');
                        
                        if (progressFill && progressText) {
                            const percentage = Math.round(progress * 100);
                            progressFill.style.width = percentage + '%';
                            progressText.textContent = percentage + '%';
                        }
                    }).then((unityInstance) => {
                        this.unityInstance = unityInstance;
                        console.log('âœ… Unity instance created successfully');
                        
                        // Apply comprehensive Unity fixes
                        this.applyUnityFixes(unityInstance);
                        
                        // Fix Unity instance errors immediately
                        this.fixUnityInstanceErrors();
                        
                        // Trigger unity ready event
                        window.dispatchEvent(new Event('unity-ready'));
                        
                        // Hide loading screen
                        this.hideLoadingScreen();
                        
                    }).catch((error) => {
                        console.error('âŒ Unity initialization failed:', error);
                        this.showError('Unity initialization failed. Please refresh the page.');
                    });

                } catch (error) {
                    console.error('âŒ Unity setup error:', error);
                    this.showError('Unity setup error. Please check your browser compatibility.');
                }
            }

            onUnityReady() {
                console.log('ðŸŽ® Unity is ready, initializing game components...');
                
                // Fix Unity instance errors first
                this.fixUnityInstanceErrors();
                
                // Update status
                this.updateStatus('playing', 'Playing');
                
                // Initialize game manager
                this.initializeGameManager();
                
                // Setup SmartFoxServer connection
                this.setupSmartFoxConnection();
            }

            // Fix Unity instance errors
            fixUnityInstanceErrors() {
                if (this.unityInstance) {
                    // Ensure unityInstance has proper methods
                    if (!this.unityInstance.on) {
                        this.unityInstance.on = function(event, callback) {
                            console.log(`Unity event listener added for: ${event}`);
                            // Store callbacks for later use
                            if (!this._eventCallbacks) this._eventCallbacks = {};
                            if (!this._eventCallbacks[event]) this._eventCallbacks[event] = [];
                            this._eventCallbacks[event].push(callback);
                        };
                    }
                    
                    // Ensure SendMessage method exists
                    if (!this.unityInstance.SendMessage) {
                        this.unityInstance.SendMessage = function(gameObject, method, parameter) {
                            console.log(`Unity SendMessage: ${gameObject}.${method}(${parameter})`);
                        };
                    }
                }
            }

            // Global Unity error handler
            setupGlobalUnityErrorHandling() {
                // Override Unity's error handling
                window.addEventListener('error', (event) => {
                    if (event.error && event.error.message) {
                        const message = event.error.message;
                        
                        // Handle Unity-specific errors
                        if (typeof message === 'string') {
                            if (message.includes('unityInstance.on is not a function')) {
                                console.warn('âš ï¸ Unity on method missing, applying fix...');
                                this.fixUnityInstanceErrors();
                                return false; // Prevent default error handling
                            }
                            
                            if (message.includes('message.includes is not a function')) {
                                console.warn('âš ï¸ Message type error, applying fix...');
                                // Fix the message handling
                                if (this.unityInstance && this.unityInstance.SendMessage) {
                                    this.unityInstance.SendMessage = function(gameObject, method, parameter) {
                                        const safeParam = typeof parameter === 'string' ? parameter : String(parameter || '');
                                        console.log(`Unity SendMessage: ${gameObject}.${method}(${safeParam})`);
                                    };
                                }
                                return false; // Prevent default error handling
                            }
                        }
                    }
                });

                // Handle unhandled promise rejections
                window.addEventListener('unhandledrejection', (event) => {
                    if (event.reason && event.reason.message) {
                        const message = event.reason.message;
                        
                        if (typeof message === 'string' && message.includes('message.includes is not a function')) {
                            console.warn('âš ï¸ Promise rejection with message.includes error, applying fix...');
                            event.preventDefault(); // Prevent the error from being logged
                            
                            // Apply fixes
                            if (this.unityInstance) {
                                this.fixUnityInstanceErrors();
                            }
                        }
                    }
                });

                            // Override console.error for Unity errors
            const originalConsoleError = console.error;
            console.error = function(...args) {
                const message = args.join(' ');
                
                // Filter out Unity framework errors that we're handling
                if (typeof message === 'string') {
                    if (message.includes('unityInstance.on is not a function') ||
                        message.includes('message.includes is not a function')) {
                        console.warn('âš ï¸ Unity error intercepted and handled:', message);
                        return; // Don't show these errors in console
                    }
                }
                
                // Call original console.error for other errors
                originalConsoleError.apply(console, args);
            };
        }

        // Apply comprehensive Unity fixes
        applyUnityFixes(unityInstance) {
            console.log('ðŸ”§ Applying comprehensive Unity fixes...');
            
            // Ensure all required methods exist
            const requiredMethods = ['on', 'SendMessage', 'SetFullscreen', 'Quit'];
            
            requiredMethods.forEach(method => {
                if (!unityInstance[method] || typeof unityInstance[method] !== 'function') {
                    console.log(`ðŸ”§ Adding missing Unity method: ${method}`);
                    
                    switch (method) {
                        case 'on':
                            unityInstance[method] = function(event, callback) {
                                console.log(`Unity event listener added for: ${event}`);
                                if (!this._eventCallbacks) this._eventCallbacks = {};
                                if (!this._eventCallbacks[event]) this._eventCallbacks[event] = [];
                                this._eventCallbacks[event].push(callback);
                            };
                            break;
                            
                        case 'SendMessage':
                            unityInstance[method] = function(gameObject, methodName, parameter) {
                                const safeParam = typeof parameter === 'string' ? parameter : String(parameter || '');
                                console.log(`Unity SendMessage: ${gameObject}.${methodName}(${safeParam})`);
                            };
                            break;
                            
                        case 'SetFullscreen':
                            unityInstance[method] = function(mode) {
                                console.log(`Unity SetFullscreen called with mode: ${mode}`);
                                // Implement fullscreen logic if needed
                            };
                            break;
                            
                        case 'Quit':
                            unityInstance[method] = function() {
                                console.log('Unity Quit called');
                                // Implement quit logic if needed
                            };
                            break;
                    }
                }
            });
            
            // Add error handling wrapper
            unityInstance._originalSendMessage = unityInstance.SendMessage;
            unityInstance.SendMessage = function(gameObject, methodName, parameter) {
                try {
                    if (typeof parameter !== 'string') {
                        parameter = String(parameter || '');
                    }
                    return this._originalSendMessage ? this._originalSendMessage(gameObject, methodName, parameter) : 
                           console.log(`Unity SendMessage: ${gameObject}.${methodName}(${parameter})`);
                } catch (error) {
                    console.warn(`âš ï¸ Unity SendMessage error handled: ${error.message}`);
                    return false;
                }
            };
            
            console.log('âœ… Unity fixes applied successfully');
        }

        // Setup audio system with automatic music and touch-to-start
        setupAudioSystem() {
            console.log('ðŸŽµ Setting up audio system...');
            
            const backgroundMusic = document.getElementById('backgroundMusic');
            const betSound = document.getElementById('betSound');
            
            if (backgroundMusic) {
                // Set initial volume
                const musicVolume = document.getElementById('musicVolume');
                if (musicVolume) {
                    backgroundMusic.volume = musicVolume.value / 100;
                } else {
                    backgroundMusic.volume = 0.6; // Default 60% volume
                }
                
                // Add touch/click to start music
                const startMusic = () => {
                    if (backgroundMusic.paused) {
                        backgroundMusic.play().then(() => {
                            console.log('ðŸŽµ Background music started');
                            this.showNotification('Music started! ðŸŽµ', 'success');
                        }).catch((error) => {
                            console.warn('âš ï¸ Could not start background music:', error);
                            this.showNotification('Click anywhere to start music', 'info');
                        });
                    }
                };
                
                // Add event listeners for user interaction
                document.addEventListener('click', startMusic, { once: true });
                document.addEventListener('touchstart', startMusic, { once: true });
                document.addEventListener('keydown', startMusic, { once: true });
                
                // Auto-start music after 2 seconds if no user interaction
                setTimeout(() => {
                    if (backgroundMusic.paused) {
                        startMusic();
                    }
                }, 2000);
                
                // Update volume when slider changes
                if (musicVolume) {
                    musicVolume.addEventListener('input', (e) => {
                        backgroundMusic.volume = e.target.value / 100;
                    });
                }
            }
            
            if (betSound) {
                // Set initial volume for bet sound
                const soundVolume = document.getElementById('soundVolume');
                if (soundVolume) {
                    betSound.volume = soundVolume.value / 100;
                } else {
                    betSound.volume = 0.8; // Default 80% volume
                }
                
                // Update volume when slider changes
                if (soundVolume) {
                    soundVolume.addEventListener('input', (e) => {
                        betSound.volume = e.target.value / 100;
                    });
                }
            }
        }

            initializeGameManager() {
                try {
                    if (this.unityInstance) {
                        // Try to find GameManager in Unity scene
                        this.unityInstance.SendMessage('GameManager', 'Initialize');
                        console.log('âœ… GameManager initialized in Unity');
                    } else {
                        console.warn('âš ï¸ Unity instance not available, using fallback GameManager');
                    }
                } catch (error) {
                    console.warn('âš ï¸ GameManager initialization failed:', error);
                }
            }

            setupSmartFoxConnection() {
                // SmartFoxServer connection setup
                if (typeof SFS2X !== 'undefined') {
                    try {
                        const sfs = new SFS2X.SmartFox();
                        
                        sfs.addEventListener(SFS2X.SFSEvent.CONNECTION, (event) => {
                            if (event.success) {
                                console.log('âœ… Connected to SmartFoxServer');
                                this.updateStatus('playing', 'Connected');
                                
                                // Login to zone
                                sfs.send(new SFS2X.LoginRequest('MKP0101', '', 'DelightShan'));
                            } else {
                                console.error('âŒ SmartFoxServer connection failed');
                                this.updateStatus('error', 'Connection Failed');
                            }
                        });

                        sfs.addEventListener(SFS2X.SFSEvent.LOGIN, (event) => {
                            console.log('âœ… Logged in to SmartFoxServer');
                            this.updateStatus('playing', 'Logged In');
                        });

                        sfs.addEventListener(SFS2X.SFSEvent.CONNECTION_LOST, (event) => {
                            console.warn('âš ï¸ SmartFoxServer connection lost');
                            this.updateStatus('error', 'Connection Lost');
                        });

                        // Connect to server
                        sfs.connect('gameserver.dlgame.online', 8443);
                        
                    } catch (error) {
                        console.error('âŒ SmartFoxServer setup failed:', error);
                    }
                } else {
                    console.warn('âš ï¸ SmartFoxServer not available');
                }
            }

            handleGameManagerEvent(eventData) {
                console.log('ðŸŽ® GameManager event:', eventData);
                
                switch (eventData.event) {
                    case 'gameReady':
                        this.onGameReady();
                        break;
                    case 'roomLoaded':
                        this.onRoomLoaded();
                        break;
                    case 'error':
                        this.showError(eventData.data.message);
                        break;
                }
            }

            onGameReady() {
                console.log('ðŸŽ® Game is ready!');
                this.isInitialized = true;
                this.updateStatus('playing', 'Ready');
                this.showNotification('Game loaded successfully!', 'success');
            }

            onRoomLoaded() {
                console.log('ðŸŽ® Game room loaded!');
                this.updateStatus('playing', 'In Room');
                this.showNotification('Entered game room!', 'success');
            }

            hideLoadingScreen() {
                const loadingScreen = document.getElementById('loadingScreen');
                if (loadingScreen) {
                    loadingScreen.classList.add('fade-out');
                    setTimeout(() => {
                        loadingScreen.style.display = 'none';
                    }, 500);
                }
            }

            handleOrientationChange() {
                const rotateMessage = document.getElementById('rotateMessage');
                if (window.innerHeight > window.innerWidth) {
                    rotateMessage.style.display = 'flex';
                } else {
                    rotateMessage.style.display = 'none';
                }
            }

            updateStatus(type, text) {
                const statusIndicator = document.getElementById('statusIndicator');
                if (statusIndicator) {
                    statusIndicator.className = `status-indicator ${type}`;
                    statusIndicator.querySelector('span').textContent = text;
                }
            }

            showModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'flex';
                }
            }

            hideModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'none';
                }
            }

            toggleFullscreen() {
                try {
                    // Check for mobile fullscreen support
                    if (window.innerHeight > window.innerWidth) {
                        // Mobile device - use screen orientation API
                        if (screen.orientation && screen.orientation.lock) {
                            screen.orientation.lock('landscape').then(() => {
                                console.log('âœ… Screen locked to landscape');
                                this.showNotification('Screen locked to landscape mode', 'success');
                            }).catch((error) => {
                                console.warn('âš ï¸ Could not lock screen orientation:', error);
                                this.showNotification('Please rotate your device manually', 'warning');
                            });
                        } else {
                            // Fallback for older browsers
                            this.showNotification('Please rotate your device to landscape mode', 'info');
                        }
                    } else {
                        // Desktop fullscreen
                        if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.mozFullScreenElement) {
                            const elem = document.documentElement;
                            if (elem.requestFullscreen) {
                                elem.requestFullscreen();
                            } else if (elem.webkitRequestFullscreen) {
                                elem.webkitRequestFullscreen();
                            } else if (elem.mozRequestFullScreen) {
                                elem.mozRequestFullScreen();
                            } else if (elem.msRequestFullscreen) {
                                elem.msRequestFullscreen();
                            }
                        } else {
                            if (document.exitFullscreen) {
                                document.exitFullscreen();
                            } else if (document.webkitExitFullscreen) {
                                document.webkitExitFullscreen();
                            } else if (document.mozCancelFullScreen) {
                                document.mozCancelFullScreen();
                            } else if (document.msExitFullscreen) {
                                document.msExitFullscreen();
                            }
                        }
                    }
                } catch (error) {
                    console.error('âŒ Fullscreen toggle failed:', error);
                    this.showNotification('Fullscreen not supported on this device', 'warning');
                }
            }

            showNotification(message, type = 'info') {
                const container = document.getElementById('notificationContainer');
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.innerHTML = `
                    <i class="fas fa-${this.getNotificationIcon(type)}"></i>
                    <span>${message}</span>
                `;
                
                container.appendChild(notification);
                
                // Show notification
                setTimeout(() => {
                    notification.classList.add('show');
                }, 100);
                
                // Remove notification after 5 seconds
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        container.removeChild(notification);
                    }, 300);
                }, 5000);
            }

            getNotificationIcon(type) {
                switch (type) {
                    case 'success': return 'check-circle';
                    case 'error': return 'exclamation-circle';
                    case 'warning': return 'exclamation-triangle';
                    case 'info': return 'info-circle';
                    default: return 'info-circle';
                }
            }

            showError(message) {
                this.showNotification(message, 'error');
                this.updateStatus('error', 'Error');
            }

            setupPerformanceMonitoring() {
                let frameCount = 0;
                let lastTime = performance.now();
                
                const monitorPerformance = () => {
                    frameCount++;
                    const currentTime = performance.now();
                    
                    if (currentTime - lastTime >= 1000) {
                        const fps = Math.round((frameCount * 1000) / (currentTime - lastTime));
                        
                        if (fps < 30) {
                            const warning = document.getElementById('performanceWarning');
                            if (warning) {
                                warning.style.display = 'block';
                                setTimeout(() => {
                                    warning.style.display = 'none';
                                }, 3000);
                            }
                        }
                        
                        frameCount = 0;
                        lastTime = currentTime;
                    }
                    
                    requestAnimationFrame(monitorPerformance);
                };
                
                requestAnimationFrame(monitorPerformance);
            }

            // Betting System
            placeBet(amount) {
                console.log(`ðŸŽ° Placing bet: ${amount}`);
                
                // Play sound effect
                this.playBetSound();
                
                // Check if player has enough balance
                const currentBalance = parseInt(document.getElementById('playerBalance').textContent.replace(/,/g, ''));
                if (currentBalance < amount) {
                    this.showNotification('Insufficient balance!', 'error');
                    return;
                }
                
                // Update selected bet amount
                document.getElementById('selectedBetAmount').textContent = amount.toLocaleString();
                
                // Show game room loading
                this.showGameRoomLoading(amount);
                
                // Simulate joining game room
                this.simulateGameRoomJoin(amount);
            }

            playBetSound() {
                try {
                    const betSound = document.getElementById('betSound');
                    if (betSound) {
                        betSound.currentTime = 0; // Reset to start
                        const soundVolume = document.getElementById('soundVolume');
                        if (soundVolume) {
                            betSound.volume = soundVolume.value / 100;
                        }
                        betSound.play().catch(e => {
                            console.warn('âš ï¸ Could not play bet sound:', e);
                        });
                    }
                } catch (error) {
                    console.warn('âš ï¸ Error playing bet sound:', error);
                }
            }

            showGameRoomLoading(amount) {
                const loadingScreen = document.getElementById('gameRoomLoading');
                if (loadingScreen) {
                    loadingScreen.style.display = 'flex';
                    
                    // Reset progress
                    const progressFill = document.getElementById('roomProgressFill');
                    const progressText = document.getElementById('roomProgressText');
                    const steps = document.querySelectorAll('.loading-steps .step');
                    
                    if (progressFill) progressFill.style.width = '0%';
                    if (progressText) progressText.textContent = 'Initializing...';
                    
                    // Reset all steps
                    steps.forEach(step => {
                        step.classList.remove('active', 'completed');
                    });
                }
            }

            hideGameRoomLoading() {
                const loadingScreen = document.getElementById('gameRoomLoading');
                if (loadingScreen) {
                    loadingScreen.style.display = 'none';
                }
            }

            simulateGameRoomJoin(amount) {
                const progressFill = document.getElementById('roomProgressFill');
                const progressText = document.getElementById('roomProgressText');
                const steps = document.querySelectorAll('.loading-steps .step');
                
                const progressSteps = [
                    { progress: 25, text: 'Connecting to server...', stepIndex: 0 },
                    { progress: 50, text: 'Finding available room...', stepIndex: 1 },
                    { progress: 75, text: 'Loading game assets...', stepIndex: 2 },
                    { progress: 100, text: 'Ready to play!', stepIndex: 3 }
                ];

                let currentStep = 0;
                
                // Check if Unity is ready
                if (!this.unityInstance) {
                    console.warn('âš ï¸ Unity instance not ready, waiting...');
                    setTimeout(() => this.simulateGameRoomJoin(amount), 1000);
                    return;
                }
                
                const updateProgress = () => {
                    if (currentStep < progressSteps.length) {
                        const step = progressSteps[currentStep];
                        
                        // Update progress bar
                        if (progressFill) {
                            progressFill.style.width = step.progress + '%';
                        }
                        
                        // Update progress text
                        if (progressText) {
                            progressText.textContent = step.text;
                        }
                        
                        // Update step indicators
                        if (steps[step.stepIndex]) {
                            // Mark previous steps as completed
                            for (let i = 0; i < step.stepIndex; i++) {
                                steps[i].classList.remove('active');
                                steps[i].classList.add('completed');
                            }
                            
                            // Mark current step as active
                            steps[step.stepIndex].classList.add('active');
                            steps[step.stepIndex].classList.remove('completed');
                        }
                        
                        currentStep++;
                        
                        if (currentStep < progressSteps.length) {
                            // Continue to next step
                            setTimeout(updateProgress, 1000 + Math.random() * 1000);
                        } else {
                            // Mark final step as completed
                            if (steps[step.stepIndex]) {
                                steps[step.stepIndex].classList.remove('active');
                                steps[step.stepIndex].classList.add('completed');
                            }
                            
                            // Complete the process
                            setTimeout(() => {
                                this.onGameRoomJoined(amount);
                            }, 1000);
                        }
                    }
                };
                
                // Start the progress simulation
                setTimeout(updateProgress, 500);
            }

            onGameRoomJoined(amount) {
                console.log(`ðŸŽ® Successfully joined game room with bet: ${amount}`);
                
                // Update player balance
                const balanceElement = document.getElementById('playerBalance');
                if (balanceElement) {
                    const currentBalance = parseInt(balanceElement.textContent.replace(/,/g, ''));
                    const newBalance = currentBalance - amount;
                    balanceElement.textContent = newBalance.toLocaleString();
                }
                
                // Hide loading screen
                this.hideGameRoomLoading();
                
                // Show success notification
                this.showNotification(`Joined game room with bet: ${amount.toLocaleString()} ðŸ’°`, 'success');
                
                // Update status
                this.updateStatus('playing', 'In Game Room');
                
                // Send bet to Unity game
                if (this.unityInstance) {
                    try {
                        // Try multiple Unity game object names
                        const gameObjects = ['GameManager', 'GameController', 'MainController', 'Game'];
                        let messageSent = false;
                        
                        for (const gameObject of gameObjects) {
                            try {
                                this.unityInstance.SendMessage(gameObject, 'OnBetPlaced', amount.toString());
                                console.log(`âœ… Bet sent to Unity ${gameObject}: ${amount}`);
                                messageSent = true;
                                break;
                            } catch (error) {
                                console.log(`âš ï¸ Could not send to ${gameObject}, trying next...`);
                            }
                        }
                        
                        if (!messageSent) {
                            console.warn('âš ï¸ Could not find Unity game object to send bet');
                        }
                    } catch (error) {
                        console.warn('âš ï¸ Could not send bet to Unity:', error);
                    }
                } else {
                    console.warn('âš ï¸ Unity instance not available for bet placement');
                }
                
                // Trigger game room joined event
                const event = new CustomEvent('gameRoomJoined', {
                    detail: { amount: amount }
                });
                window.dispatchEvent(event);
                
                // Show success message
                this.showNotification(`Successfully joined game room with bet: ${amount}`, 'success');
            }
        }

        // Initialize game when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            // Debug logo loading
            const logoImg = document.querySelector('.game-logo .main-logo');
            if (logoImg) {
                console.log('ðŸŽ¯ Logo element found:', logoImg);
                logoImg.addEventListener('load', () => {
                    console.log('âœ… Logo image loaded successfully');
                    // Ensure logo is visible
                    logoImg.style.display = 'block';
                    logoImg.style.opacity = '1';
                });
                logoImg.addEventListener('error', (e) => {
                    console.error('âŒ Logo image failed to load:', e.target.src);
                    // Show fallback
                    e.target.style.display = 'none';
                    const fallback = document.createElement('div');
                    fallback.className = 'main-logo-fallback';
                    fallback.innerHTML = 'ðŸŽ®';
                    fallback.style.cssText = `
                        width: 80px;
                        height: 80px;
                        border-radius: 16px;
                        border: 3px solid #ffd700;
                        background: linear-gradient(135deg, #ffd700, #ffed4e);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 2.5rem;
                        color: #1a1a2e;
                        margin-bottom: 1rem;
                        animation: pulse 2s infinite;
                        box-shadow: 0 8px 25px rgba(255, 215, 0, 0.4);
                    `;
                    e.target.parentNode.insertBefore(fallback, e.target);
                });
                
                // Force logo to be visible after a short delay
                setTimeout(() => {
                    if (logoImg.style.display === 'none' || logoImg.offsetParent === null) {
                        console.log('ðŸ”„ Forcing logo to be visible...');
                        logoImg.style.display = 'block';
                        logoImg.style.opacity = '1';
                        logoImg.style.visibility = 'visible';
                    }
                }, 1000);
            }
            
            new GoldenMMGame();
        });
    </script>
</body>
</html>
