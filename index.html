<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>GoldenMM - Modern Gaming Experience</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico">
    <link rel="stylesheet" href="TemplateData/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  </head>
  <body>
    <!-- Modern Loading Screen -->
    <div id="modern-loading-screen" class="loading-screen">
      <div class="loading-content">
        <div class="game-logo">
          <i class="fas fa-gamepad"></i>
          <h1>GoldenMM</h1>
        </div>
        <div class="loading-animation">
          <div class="spinner"></div>
        </div>
        <div class="loading-text">
          <p>Loading your adventure...</p>
          <div class="progress-container">
            <div class="progress-bar">
              <div class="progress-fill" id="modern-progress-fill"></div>
            </div>
            <span class="progress-text" id="modern-progress-text">0%</span>
          </div>
        </div>
        <div class="loading-tips">
          <p><i class="fas fa-lightbulb"></i> Tip: Use WASD or arrow keys to move</p>
        </div>
      </div>
    </div>

    <!-- Device Orientation Message -->
    <div id="rotate-message" class="rotate-message">
      <div class="rotate-content">
        <i class="fas fa-mobile-alt fa-rotate-90"></i>
        <h3>Please Rotate Your Device</h3>
        <p>For the best gaming experience, please rotate to landscape mode</p>
      </div>
    </div>

    <!-- Main Game Container -->
    <div id="unity-container" class="unity-container">
      <canvas id="unity-canvas" width=960 height=600 tabindex="-1"></canvas>
      
      <!-- Game Controls Overlay -->
      <div class="game-controls">
        <button class="control-btn fullscreen-btn" id="fullscreen-btn" title="Toggle Fullscreen">
          <i class="fas fa-expand"></i>
        </button>
        <button class="control-btn settings-btn" id="settings-btn" title="Game Settings">
          <i class="fas fa-cog"></i>
        </button>
        <button class="control-btn help-btn" id="help-btn" title="Help & Controls">
          <i class="fas fa-question-circle"></i>
        </button>
      </div>

      <!-- Game Title Bar -->
      <div class="game-title-bar">
        <div class="game-info">
          <span class="game-title">GoldenMM</span>
          <span class="game-version">v1.0.3</span>
        </div>
        <div class="game-status">
          <span class="status-indicator" id="status-indicator">
            <i class="fas fa-circle"></i> Ready
          </span>
        </div>
      </div>

      <!-- Warning Banner -->
      <div id="unity-warning" class="warning-banner"></div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3><i class="fas fa-cog"></i> Game Settings</h3>
          <button class="close-btn" id="close-settings">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="setting-group">
            <label>Graphics Quality</label>
            <select id="graphics-quality">
              <option value="low">Low</option>
              <option value="medium" selected>Medium</option>
              <option value="high">High</option>
            </select>
          </div>
          <div class="setting-group">
            <label>Sound Volume</label>
            <input type="range" id="sound-volume" min="0" max="100" value="80">
            <span class="volume-value">80%</span>
          </div>
          <div class="setting-group">
            <label>Music Volume</label>
            <input type="range" id="music-volume" min="0" max="100" value="60">
            <span class="volume-value">60%</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3><i class="fas fa-question-circle"></i> Help & Controls</h3>
          <button class="close-btn" id="close-help">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="control-section">
            <h4>Keyboard Controls</h4>
            <div class="control-grid">
              <div class="control-item">
                <span class="key">WASD</span>
                <span class="action">Move</span>
              </div>
              <div class="control-item">
                <span class="key">Space</span>
                <span class="action">Jump</span>
              </div>
              <div class="control-item">
                <span class="key">E</span>
                <span class="action">Interact</span>
              </div>
              <div class="control-item">
                <span class="key">ESC</span>
                <span class="action">Pause</span>
              </div>
            </div>
          </div>
          <div class="control-section">
            <h4>Mouse Controls</h4>
            <div class="control-grid">
              <div class="control-item">
                <span class="key">Left Click</span>
                <span class="action">Select</span>
              </div>
              <div class="control-item">
                <span class="key">Right Click</span>
                <span class="action">Context Menu</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Notification System -->
    <div id="notification-container" class="notification-container"></div>

    <script>
      // Modern UI State Management
      let gameInstance = null;
      let isLoading = true;
      let currentProgress = 0;
      let loadingTimeout = null;
      let isGameLoaded = false;

      // Performance monitoring
      let loadStartTime = Date.now();
      let lastProgressUpdate = 0;

      // DOM Elements
      const loadingScreen = document.getElementById('modern-loading-screen');
      const progressFill = document.getElementById('modern-progress-fill');
      const progressText = document.getElementById('modern-progress-text');
      const statusIndicator = document.getElementById('status-indicator');
      const settingsModal = document.getElementById('settings-modal');
      const helpModal = document.getElementById('help-modal');
      const notificationContainer = document.getElementById('notification-container');

      // Performance optimization settings
      const PERFORMANCE_CONFIG = {
        maxLoadTime: 30000, // 30 seconds max loading time
        progressUpdateInterval: 100, // Update progress every 100ms
        memoryThreshold: 0.8, // 80% memory usage threshold
        timeoutWarning: 15000, // Show warning after 15 seconds
        retryAttempts: 3
      };

      // Device Orientation Check
      function checkOrientation() {
        const rotateMessage = document.getElementById("rotate-message");
        if (window.innerHeight > window.innerWidth && window.innerWidth < 768) {
          rotateMessage.style.display = "flex";
        } else {
          rotateMessage.style.display = "none";
        }
      }

      // Event Listeners
      window.addEventListener("resize", checkOrientation);
      window.addEventListener("orientationchange", checkOrientation);
      checkOrientation();

      // Performance monitoring
      function checkPerformance() {
        const currentTime = Date.now();
        const loadTime = currentTime - loadStartTime;
        
        // Show warning if loading takes too long
        if (loadTime > PERFORMANCE_CONFIG.timeoutWarning && !isGameLoaded) {
          showNotification('Game is taking longer than usual to load. Please wait...', 'warning', 5000);
        }
        
        // Force timeout if loading takes too long
        if (loadTime > PERFORMANCE_CONFIG.maxLoadTime && !isGameLoaded) {
          handleLoadTimeout();
        }
      }

      // Handle loading timeout
      function handleLoadTimeout() {
        showNotification('Game loading timeout. Please refresh the page.', 'error', 10000);
        statusIndicator.innerHTML = '<i class="fas fa-circle"></i> Timeout';
        statusIndicator.className = 'status-indicator error';
        
        // Reset loading state
        isLoading = false;
        if (loadingScreen) {
          loadingScreen.style.display = 'none';
        }
      }

      // Memory monitoring
      function checkMemoryUsage() {
        if ('memory' in performance) {
          const memoryInfo = performance.memory;
          const usagePercent = memoryInfo.usedJSHeapSize / memoryInfo.jsHeapSizeLimit;
          
          if (usagePercent > PERFORMANCE_CONFIG.memoryThreshold) {
            showNotification('High memory usage detected. Consider refreshing the page.', 'warning', 5000);
          }
        }
      }

      // Optimized progress update
      function updateProgress(progress) {
        const currentTime = Date.now();
        
        // Throttle progress updates for better performance
        if (currentTime - lastProgressUpdate < PERFORMANCE_CONFIG.progressUpdateInterval) {
          return;
        }
        
        currentProgress = progress;
        lastProgressUpdate = currentTime;
        
        if (progressFill && progressText) {
          progressFill.style.width = (100 * progress) + "%";
          progressText.textContent = Math.round(100 * progress) + "%";
        }
        
        // Check performance periodically
        checkPerformance();
        
        if (progress >= 1) {
          handleGameLoaded();
        }
      }

      // Handle successful game load
      function handleGameLoaded() {
        isGameLoaded = true;
        isLoading = false;
        
        setTimeout(() => {
          if (loadingScreen) {
            loadingScreen.classList.add('fade-out');
            setTimeout(() => {
              loadingScreen.style.display = 'none';
              statusIndicator.innerHTML = '<i class="fas fa-circle"></i> Playing';
              statusIndicator.className = 'status-indicator playing';
              showNotification('Game loaded successfully!', 'success');
              
              // Start performance monitoring
              setInterval(checkMemoryUsage, 10000); // Check every 10 seconds
            }, 500);
          }
        }, 500);
      }

      // Modal Management
      function showModal(modal) {
        modal.style.display = "flex";
        document.body.style.overflow = "hidden";
      }

      function hideModal(modal) {
        modal.style.display = "none";
        document.body.style.overflow = "auto";
      }

      // Settings Modal
      document.getElementById('settings-btn').addEventListener('click', () => {
        showModal(settingsModal);
      });

      document.getElementById('close-settings').addEventListener('click', () => {
        hideModal(settingsModal);
      });

      // Help Modal
      document.getElementById('help-btn').addEventListener('click', () => {
        showModal(helpModal);
      });

      document.getElementById('close-help').addEventListener('click', () => {
        hideModal(helpModal);
      });

      // Volume Controls
      document.getElementById('sound-volume').addEventListener('input', (e) => {
        const value = e.target.value;
        e.target.nextElementSibling.textContent = value + '%';
        // Here you can add Unity audio control logic
      });

      document.getElementById('music-volume').addEventListener('input', (e) => {
        const value = e.target.value;
        e.target.nextElementSibling.textContent = value + '%';
        // Here you can add Unity audio control logic
      });

      // Enhanced Notification System
      function showNotification(message, type = 'info', duration = 3000) {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
          <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
          <span>${message}</span>
        `;
        
        notificationContainer.appendChild(notification);
        
        setTimeout(() => {
          notification.classList.add('show');
        }, 100);
        
        setTimeout(() => {
          notification.classList.remove('show');
          setTimeout(() => {
            notification.remove();
          }, 300);
        }, duration);
      }

      // Unity Integration with Performance Optimizations
      var container = document.querySelector("#unity-container");
      var canvas = document.querySelector("#unity-canvas");
      var fullscreenButton = document.getElementById("fullscreen-btn");
      var warningBanner = document.querySelector("#unity-warning");

      // Enhanced Unity banner system
      function unityShowBanner(msg, type) {
        function updateBannerVisibility() {
          warningBanner.style.display = warningBanner.children.length ? 'block' : 'none';
        }
        var div = document.createElement('div');
        div.innerHTML = msg;
        warningBanner.appendChild(div);
        
        if (type == 'error') {
          div.className = 'warning-item error';
          showNotification(msg, 'error', 5000);
          
          // Handle Unity errors gracefully
          if (msg.includes('room') || msg.includes('connection')) {
            showNotification('Connection issue detected. Please check your internet and try again.', 'warning', 8000);
          }
        } else if (type == 'warning') {
          div.className = 'warning-item warning';
          showNotification(msg, 'warning', 3000);
        } else {
          div.className = 'warning-item info';
          showNotification(msg, 'info', 2000);
        }
        
        setTimeout(function() {
          if (warningBanner.contains(div)) {
            warningBanner.removeChild(div);
            updateBannerVisibility();
          }
        }, type === 'error' ? 10000 : 5000);
        
        updateBannerVisibility();
      }

      // Unity Configuration with Performance Settings
      var buildUrl = "Build";
      var loaderUrl = buildUrl + "/SKMWebDelight.loader.js";
      
      // WebGL Compatibility Check
      function checkWebGLSupport() {
        const canvas = document.createElement('canvas');
        const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
        
        if (!gl) {
          showNotification('WebGL is not supported in your browser. Please update your browser or enable WebGL.', 'error', 10000);
          return false;
        }
        
        // Check for specific WebGL extensions and capabilities
        const extensions = gl.getSupportedExtensions();
        const hasCompressedTextures = extensions.includes('WEBGL_compressed_texture_astc') || 
                                    extensions.includes('WEBGL_compressed_texture_s3tc') ||
                                    extensions.includes('WEBGL_compressed_texture_etc');
        
        if (!hasCompressedTextures) {
          showNotification('Compressed textures not supported. Game may load slower.', 'warning', 5000);
        }
        
        // Check WebGL version
        const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
        if (debugInfo) {
          const renderer = gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL);
          console.log('WebGL Renderer:', renderer);
          
          // Check for known problematic renderers
          if (renderer.includes('Intel') || renderer.includes('AMD')) {
            showNotification('Graphics driver compatibility detected. Game may have reduced performance.', 'warning', 5000);
          }
        }
        
        return true;
      }
      
      // Enhanced Unity configuration with WebGL fallbacks
      var config = {
        dataUrl: buildUrl + "/SKMWebDelight.data",
        frameworkUrl: buildUrl + "/SKMWebDelight.framework.js",
        codeUrl: buildUrl + "/SKMWebDelight.wasm",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "Delight",
        productName: "GoldenMM",
        productVersion: "1.0.3",
        showBanner: unityShowBanner,
        // Performance optimizations
        devicePixelRatio: window.devicePixelRatio || 1,
        // Reduce initial memory allocation
        initialMemorySize: 16 * 1024 * 1024, // 16MB initial
        maximumMemorySize: 256 * 1024 * 1024, // 256MB max
        // Enable streaming for large assets
        streamingAssetsUrl: "StreamingAssets",
        // Optimize for mobile
        mobileTemplate: "PROGRESSIVE",
        // Enable compression
        compressionFormat: "BROTLI",
        // WebGL specific optimizations
        webglContextAttributes: {
          alpha: false,
          antialias: false,
          depth: true,
          failIfMajorPerformanceCaveat: false,
          powerPreference: "default",
          premultipliedAlpha: false,
          preserveDrawingBuffer: false,
          stencil: false,
          desynchronized: false
        },
        // Fallback rendering options
        fallbackQuality: "low",
        // Disable problematic features for better compatibility
        disableWebGL2: false,
        // Memory management
        memoryGrowth: true,
        // Asset streaming
        streamingAssetsUrl: "StreamingAssets"
      };

      // Mobile Detection and Setup
      if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
        container.className = "unity-container unity-mobile";
        canvas.className = "unity-mobile";
        
        // Additional mobile optimizations
        config.initialMemorySize = 8 * 1024 * 1024; // 8MB for mobile
        config.maximumMemorySize = 128 * 1024 * 1024; // 128MB max for mobile
        
        // Mobile-specific WebGL settings
        config.webglContextAttributes.antialias = false;
        config.webglContextAttributes.powerPreference = "low-power";
        config.fallbackQuality = "low";
      } else {
        canvas.style.width = "960px";
        canvas.style.height = "600px";
      }

      // Fullscreen Button
      fullscreenButton.addEventListener('click', () => {
        if (gameInstance) {
          gameInstance.SetFullscreen(1);
        }
      });

      // Enhanced Unity Loading with Error Recovery and WebGL Compatibility
      var script = document.createElement("script");
      script.src = loaderUrl;
      script.onload = () => {
        // Check WebGL support before loading Unity
        if (!checkWebGLSupport()) {
          showNotification('WebGL compatibility check failed. Please try a different browser.', 'error', 10000);
          statusIndicator.innerHTML = '<i class="fas fa-circle"></i> WebGL Error';
          statusIndicator.className = 'status-indicator error';
          return;
        }
        
        // Start performance monitoring
        const performanceInterval = setInterval(checkPerformance, 1000);
        
        // Enhanced Unity instance creation with error handling
        createUnityInstance(canvas, config, (progress) => {
          updateProgress(progress);
        }).then((unityInstance) => {
          gameInstance = unityInstance;
          clearInterval(performanceInterval);
          
          // Add Unity event listeners for better error handling
          if (unityInstance) {
            // Listen for Unity errors
            unityInstance.on('error', (error) => {
              console.error('Unity Error:', error);
              
              // Handle specific WebGL errors
              if (error.includes('WebGL') || error.includes('INVALID_ENUM')) {
                showNotification('WebGL rendering error. Trying to recover...', 'warning', 5000);
                
                // Attempt to restart with fallback settings
                setTimeout(() => {
                  if (confirm('WebGL error detected. Would you like to try with reduced graphics settings?')) {
                    restartWithFallbackSettings();
                  }
                }, 2000);
              } else {
                showNotification('Game error occurred. Please refresh the page.', 'error', 8000);
              }
            });
            
            // Listen for Unity warnings
            unityInstance.on('warning', (warning) => {
              console.warn('Unity Warning:', warning);
              
              // Handle texture format warnings
              if (warning.includes('UNorm') || warning.includes('ASTC')) {
                showNotification('Texture compatibility issue detected. Game may have reduced visual quality.', 'warning', 5000);
              } else {
                showNotification('Game warning: ' + warning, 'warning', 5000);
              }
            });
            
            // Listen for Unity ready state
            unityInstance.on('ready', () => {
              console.log('Unity instance ready');
              showNotification('Game engine ready!', 'success', 3000);
            });
          }
          
          showNotification('Welcome to GoldenMM!', 'success');
        }).catch((message) => {
          clearInterval(performanceInterval);
          console.error('Unity loading failed:', message);
          
          // Enhanced error categorization
          let errorType = 'unknown';
          let userMessage = 'Failed to load game: ' + message;
          
          if (message.includes('WebGL') || message.includes('INVALID_ENUM')) {
            errorType = 'webgl';
            userMessage = 'WebGL compatibility issue detected. Please try updating your graphics drivers or use a different browser.';
          } else if (message.includes('memory') || message.includes('out of memory')) {
            errorType = 'memory';
            userMessage = 'Insufficient memory to load game. Please close other applications and try again.';
          } else if (message.includes('network') || message.includes('fetch')) {
            errorType = 'network';
            userMessage = 'Network error while loading game files. Please check your internet connection.';
          }
          
          showNotification(userMessage, 'error', 10000);
          statusIndicator.innerHTML = '<i class="fas fa-circle"></i> ' + errorType.charAt(0).toUpperCase() + errorType.slice(1) + ' Error';
          statusIndicator.className = 'status-indicator error';
          
          // Provide specific recovery options based on error type
          setTimeout(() => {
            let retryMessage = 'Game failed to load. Would you like to retry?';
            
            if (errorType === 'webgl') {
              retryMessage = 'WebGL error detected. Would you like to try with compatibility mode?';
            } else if (errorType === 'memory') {
              retryMessage = 'Memory error detected. Would you like to try with reduced settings?';
            }
            
            if (confirm(retryMessage)) {
              if (errorType === 'webgl') {
                restartWithFallbackSettings();
              } else if (errorType === 'memory') {
                restartWithReducedMemory();
              } else {
                location.reload();
              }
            }
          }, 2000);
        });
      };
      
      // Fallback settings for WebGL compatibility issues
      function restartWithFallbackSettings() {
        showNotification('Restarting with compatibility settings...', 'info', 3000);
        
        // Update config for better compatibility
        config.webglContextAttributes.antialias = false;
        config.webglContextAttributes.depth = false;
        config.fallbackQuality = "low";
        config.initialMemorySize = 8 * 1024 * 1024; // Reduce to 8MB
        
        // Reload with new settings
        setTimeout(() => {
          location.reload();
        }, 2000);
      }
      
      // Reduced memory settings for memory issues
      function restartWithReducedMemory() {
        showNotification('Restarting with reduced memory settings...', 'info', 3000);
        
        // Update config for lower memory usage
        config.initialMemorySize = 4 * 1024 * 1024; // Reduce to 4MB
        config.maximumMemorySize = 64 * 1024 * 1024; // Reduce to 64MB
        
        // Reload with new settings
        setTimeout(() => {
          location.reload();
        }, 2000);
      }
      
      // Handle script loading errors
      script.onerror = () => {
        showNotification('Failed to load game files. Please check your internet connection.', 'error', 10000);
        statusIndicator.innerHTML = '<i class="fas fa-circle"></i> Load Error';
        statusIndicator.className = 'status-indicator error';
      };
      
      document.body.appendChild(script);

      // Close modals when clicking outside
      window.addEventListener('click', (e) => {
        if (e.target === settingsModal) hideModal(settingsModal);
        if (e.target === helpModal) hideModal(helpModal);
      });

      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          if (settingsModal.style.display === 'flex') hideModal(settingsModal);
          if (helpModal.style.display === 'flex') hideModal(helpModal);
        }
      });

      // Page visibility API for better performance
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
          // Page is hidden, reduce performance
          if (gameInstance) {
            // Pause Unity if possible
            try {
              gameInstance.SendMessage('GameManager', 'OnPageHidden');
            } catch (e) {
              // Unity not ready yet
            }
          }
        } else {
          // Page is visible, restore performance
          if (gameInstance) {
            try {
              gameInstance.SendMessage('GameManager', 'OnPageVisible');
            } catch (e) {
              // Unity not ready yet
            }
          }
        }
      });

      // Handle page unload gracefully
      window.addEventListener('beforeunload', () => {
        if (gameInstance) {
          try {
            // Clean up Unity resources
            gameInstance.Quit();
          } catch (e) {
            // Unity already unloaded
          }
        }
      });

      // Performance warning for slow devices
      if ('connection' in navigator) {
        const connection = navigator.connection;
        if (connection.effectiveType === 'slow-2g' || connection.effectiveType === '2g') {
          showNotification('Slow connection detected. Game may take longer to load.', 'warning', 8000);
        }
      }
    </script>
  </body>
</html>
