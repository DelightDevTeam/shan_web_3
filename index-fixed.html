<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoldenMM - Fixed Version</title>
    <link rel="stylesheet" href="TemplateData/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Additional error handling styles */
        .connection-error {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .error-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            max-width: 400px;
            border: 2px solid #f87171;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }
        
        .error-content h3 {
            color: #f87171;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }
        
        .error-content p {
            color: #e0e0e0;
            margin-bottom: 1.5rem;
        }
        
        .error-content button {
            background: linear-gradient(135deg, #f87171, #ef4444);
            color: #ffffff;
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .error-content button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(248, 113, 113, 0.4);
        }
        
        /* Unity container fixes */
        #unity-container {
            position: relative;
            z-index: 1;
        }
        
        /* Loading improvements */
        .loading-screen {
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
        }
        
        .loading-tips {
            background: rgba(255, 255, 255, 0.05);
            border-left: 4px solid #ffd700;
        }
        
        /* Performance optimizations */
        .performance-warning {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(168, 85, 247, 0.9);
            color: #ffffff;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            z-index: 1000;
            display: none;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-content">
            <div class="game-logo">
                <i class="fas fa-gamepad"></i>
                <h1>GoldenMM</h1>
            </div>
            
            <div class="loading-animation">
                <div class="spinner"></div>
            </div>
            
            <div class="loading-text">
                <p>Loading your adventure...</p>
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <span class="progress-text" id="progressText">0%</span>
                </div>
            </div>
            
            <div class="loading-tips">
                <p><i class="fas fa-lightbulb"></i> Tip: Use WASD or arrow keys to move</p>
            </div>
        </div>
    </div>

    <!-- Rotate Message -->
    <div class="rotate-message" id="rotateMessage">
        <div class="rotate-content">
            <i class="fas fa-mobile-alt"></i>
            <h3>Please Rotate Your Device</h3>
            <p>For the best gaming experience, please rotate to landscape mode</p>
        </div>
    </div>

    <!-- Performance Warning -->
    <div class="performance-warning" id="performanceWarning">
        <i class="fas fa-exclamation-triangle"></i>
        Performance optimizations applied for better gameplay
    </div>

    <!-- Unity Container -->
    <div id="unity-container" class="unity-container">
        <canvas id="unity-canvas"></canvas>
    </div>

    <!-- Game Controls -->
    <div class="game-controls">
        <button class="control-btn" id="settingsBtn" title="Settings">
            <i class="fas fa-cog"></i>
        </button>
        <button class="control-btn" id="helpBtn" title="Help">
            <i class="fas fa-question"></i>
        </button>
        <button class="control-btn" id="fullscreenBtn" title="Fullscreen">
            <i class="fas fa-expand"></i>
        </button>
    </div>

    <!-- Game Title Bar -->
    <div class="game-title-bar">
        <div class="game-info">
            <div class="game-title">GoldenMM v1.0.3</div>
            <div class="game-version">Fixed Version</div>
        </div>
        <div class="game-status">
            <div class="status-indicator" id="statusIndicator">
                <i class="fas fa-circle"></i>
                <span>Ready</span>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-cog"></i> Game Settings</h3>
                <button class="close-btn" id="closeSettings">&times;</button>
            </div>
            <div class="modal-body">
                <div class="setting-group">
                    <label>Graphics Quality</label>
                    <select id="graphicsQuality">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label>Sound Volume</label>
                    <input type="range" id="soundVolume" min="0" max="100" value="80">
                    <span class="volume-value" id="soundVolumeValue">80%</span>
                </div>
                <div class="setting-group">
                    <label>Music Volume</label>
                    <input type="range" id="musicVolume" min="0" max="100" value="60">
                    <span class="volume-value" id="musicVolumeValue">60%</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div class="modal" id="helpModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-question"></i> Help & Controls</h3>
                <button class="close-btn" id="closeHelp">&times;</button>
            </div>
            <div class="modal-body">
                <div class="control-section">
                    <h4>Keyboard Controls</h4>
                    <div class="control-grid">
                        <div class="control-item">
                            <span class="key">WASD</span>
                            <span class="action">Move</span>
                        </div>
                        <div class="control-item">
                            <span class="key">Space</span>
                            <span class="action">Jump</span>
                        </div>
                        <div class="control-item">
                            <span class="key">E</span>
                            <span class="action">Interact</span>
                        </div>
                        <div class="control-item">
                            <span class="key">ESC</span>
                            <span class="action">Pause</span>
                        </div>
                    </div>
                </div>
                <div class="control-section">
                    <h4>Mouse Controls</h4>
                    <div class="control-grid">
                        <div class="control-item">
                            <span class="key">Left Click</span>
                            <span class="action">Select</span>
                        </div>
                        <div class="control-item">
                            <span class="key">Right Click</span>
                            <span class="action">Context Menu</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div class="notification-container" id="notificationContainer"></div>

    <!-- Unity WebGL Fixes Script -->
    <script src="unity-webgl-fixes.js"></script>

    <!-- Main Game Script -->
    <script>
        // Game initialization with error handling
        class GoldenMMGame {
            constructor() {
                this.isInitialized = false;
                this.unityInstance = null;
                this.gameManager = null;
                this.setupEventListeners();
                this.initializeGame();
            }

            setupEventListeners() {
                // Settings button
                document.getElementById('settingsBtn').addEventListener('click', () => {
                    this.showModal('settingsModal');
                });

                // Help button
                document.getElementById('helpBtn').addEventListener('click', () => {
                    this.showModal('helpModal');
                });

                // Fullscreen button
                document.getElementById('fullscreenBtn').addEventListener('click', () => {
                    this.toggleFullscreen();
                });

                // Close buttons
                document.getElementById('closeSettings').addEventListener('click', () => {
                    this.hideModal('settingsModal');
                });

                document.getElementById('closeHelp').addEventListener('click', () => {
                    this.hideModal('helpModal');
                });

                // Volume controls
                document.getElementById('soundVolume').addEventListener('input', (e) => {
                    document.getElementById('soundVolumeValue').textContent = e.target.value + '%';
                });

                document.getElementById('musicVolume').addEventListener('input', (e) => {
                    document.getElementById('musicVolumeValue').textContent = e.target.value + '%';
                });

                // Modal backdrop clicks
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            this.hideModal(modal.id);
                        }
                    });
                });

                // Device orientation
                window.addEventListener('orientationchange', () => {
                    this.handleOrientationChange();
                });

                // Unity ready event
                window.addEventListener('unity-ready', () => {
                    this.onUnityReady();
                });

                // Game manager events
                window.addEventListener('gameManagerEvent', (e) => {
                    this.handleGameManagerEvent(e.detail);
                });
            }

            initializeGame() {
                console.log('🎮 Initializing GoldenMM Game...');
                
                // Check device orientation
                this.handleOrientationChange();
                
                // Initialize Unity WebGL
                this.initializeUnity();
                
                // Setup performance monitoring
                this.setupPerformanceMonitoring();
            }

            initializeUnity() {
                try {
                    // Load Unity WebGL build
                    const canvas = document.getElementById('unity-canvas');
                    const loadingBar = document.getElementById('unity-loading-bar');
                    
                    // Unity configuration
                    const unityConfig = {
                        dataUrl: 'Build/SKMWebDelight.data',
                        frameworkUrl: 'Build/SKMWebDelight.framework.js',
                        codeUrl: 'Build/SKMWebDelight.wasm',
                        streamingAssetsUrl: 'StreamingAssets',
                        companyName: 'GoldenMM',
                        productName: 'GoldenMM Game',
                        productVersion: '1.0.3',
                        devicePixelRatio: 1,
                    };

                    // Create Unity instance
                    createUnityInstance(canvas, unityConfig, (progress) => {
                        // Update loading progress
                        const progressFill = document.getElementById('progressFill');
                        const progressText = document.getElementById('progressText');
                        
                        if (progressFill && progressText) {
                            const percentage = Math.round(progress * 100);
                            progressFill.style.width = percentage + '%';
                            progressText.textContent = percentage + '%';
                        }
                    }).then((unityInstance) => {
                        this.unityInstance = unityInstance;
                        console.log('✅ Unity instance created successfully');
                        
                        // Trigger unity ready event
                        window.dispatchEvent(new Event('unity-ready'));
                        
                        // Hide loading screen
                        this.hideLoadingScreen();
                        
                    }).catch((error) => {
                        console.error('❌ Unity initialization failed:', error);
                        this.showError('Unity initialization failed. Please refresh the page.');
                    });

                } catch (error) {
                    console.error('❌ Unity setup error:', error);
                    this.showError('Unity setup error. Please check your browser compatibility.');
                }
            }

            onUnityReady() {
                console.log('🎮 Unity is ready, initializing game components...');
                
                // Update status
                this.updateStatus('playing', 'Playing');
                
                // Initialize game manager
                this.initializeGameManager();
                
                // Setup SmartFoxServer connection
                this.setupSmartFoxConnection();
            }

            initializeGameManager() {
                try {
                    if (this.unityInstance) {
                        // Try to find GameManager in Unity scene
                        this.unityInstance.SendMessage('GameManager', 'Initialize');
                        console.log('✅ GameManager initialized in Unity');
                    } else {
                        console.warn('⚠️ Unity instance not available, using fallback GameManager');
                    }
                } catch (error) {
                    console.warn('⚠️ GameManager initialization failed:', error);
                }
            }

            setupSmartFoxConnection() {
                // SmartFoxServer connection setup
                if (typeof SFS2X !== 'undefined') {
                    try {
                        const sfs = new SFS2X.SmartFox();
                        
                        sfs.addEventListener(SFS2X.SFSEvent.CONNECTION, (event) => {
                            if (event.success) {
                                console.log('✅ Connected to SmartFoxServer');
                                this.updateStatus('playing', 'Connected');
                                
                                // Login to zone
                                sfs.send(new SFS2X.LoginRequest('MKP0101', '', 'DelightShan'));
                            } else {
                                console.error('❌ SmartFoxServer connection failed');
                                this.updateStatus('error', 'Connection Failed');
                            }
                        });

                        sfs.addEventListener(SFS2X.SFSEvent.LOGIN, (event) => {
                            console.log('✅ Logged in to SmartFoxServer');
                            this.updateStatus('playing', 'Logged In');
                        });

                        sfs.addEventListener(SFS2X.SFSEvent.CONNECTION_LOST, (event) => {
                            console.warn('⚠️ SmartFoxServer connection lost');
                            this.updateStatus('error', 'Connection Lost');
                        });

                        // Connect to server
                        sfs.connect('gameserver.dlgame.online', 8443);
                        
                    } catch (error) {
                        console.error('❌ SmartFoxServer setup failed:', error);
                    }
                } else {
                    console.warn('⚠️ SmartFoxServer not available');
                }
            }

            handleGameManagerEvent(eventData) {
                console.log('🎮 GameManager event:', eventData);
                
                switch (eventData.event) {
                    case 'gameReady':
                        this.onGameReady();
                        break;
                    case 'roomLoaded':
                        this.onRoomLoaded();
                        break;
                    case 'error':
                        this.showError(eventData.data.message);
                        break;
                }
            }

            onGameReady() {
                console.log('🎮 Game is ready!');
                this.isInitialized = true;
                this.updateStatus('playing', 'Ready');
                this.showNotification('Game loaded successfully!', 'success');
            }

            onRoomLoaded() {
                console.log('🎮 Game room loaded!');
                this.updateStatus('playing', 'In Room');
                this.showNotification('Entered game room!', 'success');
            }

            hideLoadingScreen() {
                const loadingScreen = document.getElementById('loadingScreen');
                if (loadingScreen) {
                    loadingScreen.classList.add('fade-out');
                    setTimeout(() => {
                        loadingScreen.style.display = 'none';
                    }, 500);
                }
            }

            handleOrientationChange() {
                const rotateMessage = document.getElementById('rotateMessage');
                if (window.innerHeight > window.innerWidth) {
                    rotateMessage.style.display = 'flex';
                } else {
                    rotateMessage.style.display = 'none';
                }
            }

            updateStatus(type, text) {
                const statusIndicator = document.getElementById('statusIndicator');
                if (statusIndicator) {
                    statusIndicator.className = `status-indicator ${type}`;
                    statusIndicator.querySelector('span').textContent = text;
                }
            }

            showModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'flex';
                }
            }

            hideModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'none';
                }
            }

            toggleFullscreen() {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                } else {
                    document.exitFullscreen();
                }
            }

            showNotification(message, type = 'info') {
                const container = document.getElementById('notificationContainer');
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.innerHTML = `
                    <i class="fas fa-${this.getNotificationIcon(type)}"></i>
                    <span>${message}</span>
                `;
                
                container.appendChild(notification);
                
                // Show notification
                setTimeout(() => {
                    notification.classList.add('show');
                }, 100);
                
                // Remove notification after 5 seconds
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        container.removeChild(notification);
                    }, 300);
                }, 5000);
            }

            getNotificationIcon(type) {
                switch (type) {
                    case 'success': return 'check-circle';
                    case 'error': return 'exclamation-circle';
                    case 'warning': return 'exclamation-triangle';
                    case 'info': return 'info-circle';
                    default: return 'info-circle';
                }
            }

            showError(message) {
                this.showNotification(message, 'error');
                this.updateStatus('error', 'Error');
            }

            setupPerformanceMonitoring() {
                let frameCount = 0;
                let lastTime = performance.now();
                
                const monitorPerformance = () => {
                    frameCount++;
                    const currentTime = performance.now();
                    
                    if (currentTime - lastTime >= 1000) {
                        const fps = Math.round((frameCount * 1000) / (currentTime - lastTime));
                        
                        if (fps < 30) {
                            const warning = document.getElementById('performanceWarning');
                            if (warning) {
                                warning.style.display = 'block';
                                setTimeout(() => {
                                    warning.style.display = 'none';
                                }, 3000);
                            }
                        }
                        
                        frameCount = 0;
                        lastTime = currentTime;
                    }
                    
                    requestAnimationFrame(monitorPerformance);
                };
                
                requestAnimationFrame(monitorPerformance);
            }
        }

        // Initialize game when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            new GoldenMMGame();
        });
    </script>
</body>
</html>
